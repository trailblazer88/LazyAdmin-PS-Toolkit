Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

using namespace System.Windows.Forms
using namespace System.Drawing

$form = New-Object Form
$form.Text = "AD Lockout & Bad Password Tracer"
$form.Size = New-Object Size(1050, 720)
$form.StartPosition = "CenterScreen"
$form.Font = New-Object Font("Segoe UI", 10)
$form.BackColor = [Color]::White
$form.MinimumSize = New-Object Size(1050, 720)

# Input panel
$inputPanel = New-Object Panel
$inputPanel.Location = New-Object Point(10,10)
$inputPanel.Size = New-Object Size(1020,70)
$inputPanel.Anchor = 'Top, Left, Right'
$form.Controls.Add($inputPanel)

# Username
$lblUser = New-Object Label
$lblUser.Text = "Username:"
$lblUser.Location = New-Object Point(10,20)
$lblUser.AutoSize = $true
$inputPanel.Controls.Add($lblUser)

$txtUser = New-Object TextBox
$txtUser.Location = New-Object Point(90,15)
$txtUser.Size = New-Object Size(180,25)
$inputPanel.Controls.Add($txtUser)

# Domain
$lblDomain = New-Object Label
$lblDomain.Text = "Domain:"
$lblDomain.Location = New-Object Point(290,20)
$lblDomain.AutoSize = $true
$inputPanel.Controls.Add($lblDomain)

$cmbDomain = New-Object ComboBox
$cmbDomain.Location = New-Object Point(350,15)
$cmbDomain.Size = New-Object Size(200,25)
$cmbDomain.DropDownStyle = 'DropDownList'
$inputPanel.Controls.Add($cmbDomain)

# From date
$lblFrom = New-Object Label
$lblFrom.Text = "From:"
$lblFrom.Location = New-Object Point(570,20)
$lblFrom.AutoSize = $true
$inputPanel.Controls.Add($lblFrom)

$dtpFrom = New-Object DateTimePicker
$dtpFrom.Location = New-Object Point(620,15)
$dtpFrom.Size = New-Object Size(130,25)
$dtpFrom.Value = (Get-Date).AddDays(-1)
$inputPanel.Controls.Add($dtpFrom)

# To date
$lblTo = New-Object Label
$lblTo.Text = "To:"
$lblTo.Location = New-Object Point(770,20)
$lblTo.AutoSize = $true
$inputPanel.Controls.Add($lblTo)

$dtpTo = New-Object DateTimePicker
$dtpTo.Location = New-Object Point(800,15)
$dtpTo.Size = New-Object Size(130,25)
$dtpTo.Value = Get-Date
$inputPanel.Controls.Add($dtpTo)

# Run button
$btnRun = New-Object Button
$btnRun.Text = "Run Trace"
$btnRun.Location = New-Object Point(950,15)
$btnRun.Size = New-Object Size(80,30)
$inputPanel.Controls.Add($btnRun)

# DC List panel
$dcPanel = New-Object Panel
$dcPanel.Location = New-Object Point(10,90)
$dcPanel.Size = New-Object Size(500,550)
$dcPanel.Anchor = 'Top, Left, Bottom'
$form.Controls.Add($dcPanel)

# Event List panel
$eventPanel = New-Object Panel
$eventPanel.Location = New-Object Point(520,90)
$eventPanel.Size = New-Object Size(510,550)
$eventPanel.Anchor = 'Top, Right, Bottom'
$form.Controls.Add($eventPanel)

# DC ListView
$lvDC = New-Object ListView
$lvDC.View = 'Details'
$lvDC.FullRowSelect = $true
$lvDC.GridLines = $true
$lvDC.Dock = 'Fill'
$lvDC.Columns.Add("Domain Controller", 230) | Out-Null
$lvDC.Columns.Add("Status", 240) | Out-Null
$dcPanel.Controls.Add($lvDC)

# Event ListView
$lvEvt = New-Object ListView
$lvEvt.View = 'Details'
$lvEvt.FullRowSelect = $true
$lvEvt.GridLines = $true
$lvEvt.Dock = 'Fill'
"DC","Caller","Time","EventID","Reason" | ForEach-Object { $lvEvt.Columns.Add($_,100) | Out-Null }
$eventPanel.Controls.Add($lvEvt)

# Progress bar
$progress = New-Object ProgressBar
$progress.Location = New-Object Point(10,660)
$progress.Size = New-Object Size(1020, 20)
$progress.Anchor = 'Bottom, Left, Right'
$form.Controls.Add($progress)

# Status bar
$statusBar = New-Object StatusStrip
$statusBar.Location = New-Object Point(0,685)
$statusBar.Size = New-Object Size(1040, 25)
$statusBar.Anchor = 'Bottom, Left, Right'
$form.Controls.Add($statusBar)

# Status labels
$statusLabel = New-Object ToolStripStatusLabel
$statusLabel.Text = "Ready"
$statusBar.Items.Add($statusLabel)

$statusDCLabel = New-Object ToolStripStatusLabel
$statusDCLabel.Text = ""
$statusBar.Items.Add($statusDCLabel)

# Export button
$btnExport = New-Object Button
$btnExport.Text = "Export CSV"
$btnExport.Location = New-Object Point(10,620)
$btnExport.Size = New-Object Size(100,30)
$btnExport.Enabled = $false
$btnExport.Anchor = 'Bottom, Left'
$form.Controls.Add($btnExport)

# Load domain list
try {
    $forest = [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()
    foreach ($domain in $forest.Domains) {
        $cmbDomain.Items.Add($domain.Name) | Out-Null
    }
    if ($cmbDomain.Items.Count -gt 0) { $cmbDomain.SelectedIndex = 0 }
} catch {
    [MessageBox]::Show("Error loading domain list:`n$($_.Exception.Message)")
}

# Variables to track job & progress
$global:Job = $null
$global:ProgressIndex = 0
$global:DCs = @()
$global:Results = @()
$global:Statuses = @()

# Background job script block
$scriptBlock = {
    param($user, $domain, $from, $to, $eventIds)

    $results = @()
    $statuses = @()

    try {
        $forest = [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()
        $targetDomain = $forest.Domains | Where-Object { $_.Name -ieq $domain }
        if (-not $targetDomain) {
            throw "Domain '$domain' not found in forest."
        }

        $dcs = $targetDomain.DomainControllers
        $totalDCs = $dcs.Count
        for ($i=0; $i -lt $totalDCs; $i++) {
            $dc = $dcs[$i]
            # Write progress to a temp file (or PS variable won't survive job boundaries)
            $progressPath = Join-Path $env:TEMP "lockout_trace_progress.txt"
            "$($i+1)/$totalDCs $($dc.Name)" | Out-File -FilePath $progressPath -Encoding ASCII

            $status = "Success"
            try {
                $logs = Get-WinEvent -ComputerName $dc.Name -FilterHashtable @{
                    LogName='Security'; ID=$eventIds; StartTime=$from; EndTime=$to
                } -ErrorAction Stop

                foreach ($log in $logs) {
                    $xml = [xml]$log.ToXml()
                    $target = ($xml.Event.EventData.Data | Where-Object Name -eq "TargetUserName").'#text'
                    if ($target -ieq $user) {
                        $caller = ($xml.Event.EventData.Data | Where-Object Name -match "CallerComputerName|WorkstationName|Workstation").'#text'
                        $reason = switch ($log.Id) {
                            4740 { 'Lockout' }
                            4625 { 'Failed Logon' }
                            4771 { 'Kerberos Fail' }
                            4776 { 'NTLM Fail' }
                            default { 'Other' }
                        }
                        $results += [pscustomobject]@{
                            DC = $dc.Name
                            Caller = $caller
                            Time = $log.TimeCreated
                            EventID = $log.Id
                            Reason = $reason
                        }
                    }
                }
            } catch {
                $status = "Error: $($_.Exception.Message -split '\n')[0]"
            }
            $statuses += [pscustomobject]@{ DC = $dc.Name; Status = $status }
        }

        # Remove progress file after done
        Remove-Item $progressPath -ErrorAction Ignore

        return @{ Results = $results; Statuses = $statuses }
    }
    catch {
        return @{ Results = @(); Statuses = @([pscustomobject]@{ DC = 'N/A'; Status = $_.Exception.Message }) }
    }
}

# Timer to update status from progress file
$progressTimer = New-Object Timers.Timer
$progressTimer.Interval = 1000
$progressTimer.AutoReset = $true
$progressTimer.Enabled = $false
$progressTimer.Add_Elapsed({
    if (Test-Path $env:TEMP\lockout_trace_progress.txt) {
        $line = Get-Content $env:TEMP\lockout_trace_progress.txt -ErrorAction SilentlyContinue
        if ($line) {
            $form.Invoke([action]{
                $statusDCLabel.Text = "Processing DC: $line"
            })
        }
    }
})

# Run button click handler
$btnRun.Add_Click({
    $user = $txtUser.Text.Trim()
    $domain = $cmbDomain.SelectedItem
    $from = $dtpFrom.Value
    $to = $dtpTo.Value
    $eventIds = 4740,4625,4771,4776

    if (-not $user) { [MessageBox]::Show("Please enter a username."); return }
    if (-not $domain) { [MessageBox]::Show("Please select a domain."); return }
    if ($from -gt $to) { [MessageBox]::Show("'From' date must be before 'To'"); return }

    $btnRun.Enabled = $false
    $btnExport.Enabled = $false
    $lvDC.Items.Clear()
    $lvEvt.Items.Clear()
    $progress.Style = 'Marquee'
    $statusLabel.Text = "Running..."
    $statusDCLabel.Text = ""

    # Start timer for progress updates
    $progressTimer.Start()

    # Start job
    $global:Job = Start-Job -ScriptBlock $scriptBlock -ArgumentList $user, $domain, $from, $to, $eventIds
})

# Timer to check job completion
$jobCheckTimer = New-Object Timers.Timer
$jobCheckTimer.Interval = 2000
$jobCheckTimer.AutoReset = $true
$jobCheckTimer.Enabled = $true
$jobCheckTimer.Add_Elapsed({
    if ($global:Job -and ($global:Job.State -eq 'Completed' -or $global:Job.State -eq 'Failed')) {
        $jobCheckTimer.Stop()
        $progressTimer.Stop()
        $progress.Style = 'Blocks'

        try {
            $output = Receive-Job -Job $global:Job -ErrorAction Stop
            Remove-Job -Job $global:Job -Force
            $global:Job = $null

            $form.Invoke([action]{
                $statusLabel.Text = "Completed"
                $statusDCLabel.Text = ""

                # Update DC ListView statuses
                $lvDC.Items.Clear()
                foreach ($status in $output.Statuses) {
                    $item = New-Object ListViewItem $status.DC
                    $item.SubItems.Add($status.Status)
                    $lvDC.Items.Add($item)
                }

                # Update event list
                $lvEvt.Items.Clear()
                foreach ($evt in $output.Results) {
                    $item = New-Object ListViewItem $evt.DC
                    $item.SubItems.Add($evt.Caller)
                    $item.SubItems.Add($evt.Time.ToString())
                    $item.SubItems.Add($evt.EventID.ToString())
                    $item.SubItems.Add($evt.Reason)
                    $lvEvt.Items.Add($item)
                }

                $btnRun.Enabled = $true
                $btnExport.Enabled = $lvEvt.Items.Count -gt 0
            })
        }
        catch {
            $form.Invoke([action]{
                [MessageBox]::Show("Error retrieving results: $_")
                $btnRun.Enabled = $true
                $statusLabel.Text = "Error"
                $statusDCLabel.Text = ""
            })
        }
    }
})

# Export button click handler
$btnExport.Add_Click({
    $sfd = New-Object SaveFileDialog
    $sfd.Filter = "CSV Files (*.csv)|*.csv"
    $sfd.FileName = "LockoutTrace_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
    if ($sfd.ShowDialog() -eq [DialogResult]::OK) {
        $items = @()
        foreach ($item in $lvEvt.Items) {
            $items += [pscustomobject]@{
                DC = $item.SubItems[0].Text
                Caller = $item.SubItems[1].Text
                Time = $item.SubItems[2].Text
                EventID = $item.SubItems[3].Text
                Reason = $item.SubItems[4].Text
            }
        }
        $items | Export-Csv -Path $sfd.FileName -NoTypeInformation
        [MessageBox]::Show("Export completed: $($sfd.FileName)")
    }
})

# Show the form
[void]$form.ShowDialog()
